kind: pipeline
type: docker
name: deploy notodo

clone:
  retries: 3

volumes:
  - name: dockersock
    host:
      path: /var/run/docker.sock

steps:
  - name: test
    image: golang:1.20
    commands:
      - echo "GOPROXY: $GOPROXY"
      - go test -v ./...
    environment:
      GOPROXY: https://goproxy.cn

  - name: deploy
    image: docker:dind
    volumes:
      - name: dockersock
        path: /var/run/docker.sock
    commands:
      - echo "GOPROXY: $GOPROXY"
      - docker compose up -d
    environment:
      GOPROXY: https://goproxy.cn
      MONGO_URI:
        from_secret: MONGO_URI
